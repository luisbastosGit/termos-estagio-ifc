<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termo de Compromisso de Estágio - Dados do Aluno</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f4f4;
            padding-top: 20px;
        }
        .container {
            max-width: 800px;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .spinner-border {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center mb-4">Termo de Compromisso de Estágio - Dados do Aluno</h2>
        <div id="alert-container"></div>
        <form id="student-form">
            <!-- Campos do formulário -->
            <div class="form-row">
                <div class="form-group col-md-8">
                    <label for="nome-completo">Nome Completo do Aluno:</label>
                    <input type="text" class="form-control" id="nome-completo" name="nome-completo" required>
                </div>
                <div class="form-group col-md-4">
                    <label for="cpf">CPF:</label>
                    <input type="text" class="form-control" id="cpf" name="cpf" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="matricula">Matrícula:</label>
                    <input type="text" class="form-control" id="matricula" name="matricula" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="data-nascimento">Data de Nascimento:</label>
                    <input type="date" class="form-control" id="data-nascimento" name="data-nascimento" required>
                </div>
            </div>
            <div class="form-row">
                 <div class="form-group col-md-6">
                    <label for="email-aluno">E-mail do Aluno:</label>
                    <input type="email" class="form-control" id="email-aluno" name="email-aluno" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="telefone-aluno">Telefone/WhatsApp do Aluno:</label>
                    <input type="text" class="form-control" id="telefone-aluno" name="telefone-aluno" required>
                </div>
            </div>
            <div class="form-row">
                 <div class="form-group col-md-6">
                    <label for="curso">Curso:</label>
                    <select class="form-control" id="curso" name="curso" required>
                        <option value="">Selecione o Curso</option>
                        <option value="Técnico em Agropecuária Integrado ao Ensino Médio">Técnico em Agropecuária Integrado ao Ensino Médio</option>
                        <option value="Técnico em Alimentos Integrado ao Ensino Médio">Técnico em Alimentos Integrado ao Ensino Médio</option>
                        <option value="Técnico em Informática Integrado ao Ensino Médio">Técnico em Informática Integrado ao Ensino Médio</option>
                        <option value="Técnico em Alimentos Subsequente">Técnico em Alimentos Subsequente</option>
                        <option value="Agronomia">Agronomia</option>
                        <option value="Ciência da Computação">Ciência da Computação</option>
                        <option value="Engenharia de Alimentos">Engenharia de Alimentos</option>
                        <option value="Licenciatura em Física">Licenciatura em Física</option>
                        <option value="Licenciatura em Matemática">Licenciatura em Matemática</option>
                        <option value="Medicina Veterinária">Medicina Veterinária</option>
                        <option value="Pós-Graduação Lato Sensu em Educação e Diversidade">Pós-Graduação Lato Sensu em Educação e Diversidade</option>
                        <option value="Pós-Graduação Stricto Sensu em Produção e Sanidade Animal">Pós-Graduação Stricto Sensu em Produção e Sanidade Animal</option>
                    </select>
                </div>
                 <div class="form-group col-md-6">
                    <label for="turma-fase">Turma / Fase:</label>
                    <select class="form-control" id="turma-fase" name="turma-fase" required>
                        <option value="">Selecione a Turma/Fase</option>
                        <option value="1ª A">1ª A</option>
                        <option value="1ª B">1ª B</option>
                        <option value="1ª C">1ª C</option>
                        <option value="2ª A">2ª A</option>
                        <option value="2ª B">2ª B</option>
                        <option value="2ª C">2ª C</option>
                        <option value="3ª A">3ª A</option>
                        <option value="3ª B">3ª B</option>
                        <option value="3ª C">3ª C</option>
                        <option value="4ª">4ª</option>
                        <option value="5ª">5ª</option>
                        <option value="6ª">6ª</option>
                        <option value="7ª">7ª</option>
                        <option value="8ª">8ª</option>
                        <option value="9ª">9ª</option>
                        <option value="10ª">10ª</option>
                    </select>
                </div>
            </div>
             <div class="form-group">
                <label for="nome-orientador">Nome do Orientador no IFC:</label>
                <select class="form-control" id="nome-orientador" name="nome-orientador" required>
                    <option value="">A carregar orientadores...</option>
                </select>
            </div>
            
            <button type="submit" id="submit-button" class="btn btn-primary btn-block">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Enviar Dados e Prosseguir
            </button>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        // URL da nossa nova API no Render
        const API_URL = "https://api-estagios-backend.onrender.com";

        document.addEventListener('DOMContentLoaded', async () => {
            await loadOrientadores();
            document.getElementById('student-form').addEventListener('submit', enviarDadosAluno);
        });

        async function loadOrientadores() {
            const select = document.getElementById('nome-orientador');
            try {
                const response = await fetch(`${API_URL}/orientadores`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(`Erro de rede: ${response.statusText} - ${errorData ? errorData.message : ''}`);
                }
                const result = await response.json();
                if (result.success) {
                    select.innerHTML = '<option value="">Selecione o Orientador</option>';
                    result.data.forEach(nome => {
                        const option = document.createElement('option');
                        option.value = nome;
                        option.textContent = nome;
                        select.appendChild(option);
                    });
                } else {
                    throw new Error(result.message || 'Não foi possível carregar os orientadores.');
                }
            } catch (error) {
                console.error('Erro ao carregar orientadores:', error);
                select.innerHTML = '<option value="">Não foi possível carregar a lista</option>';
                showAlert(`Não foi possível carregar os orientadores. (${error.message})`, 'danger');
            }
        }

        async function enviarDadosAluno(e) {
            e.preventDefault();
            const form = e.target;
            const button = document.getElementById('submit-button');
            const spinner = button.querySelector('.spinner-border');

            button.disabled = true;
            spinner.style.display = 'inline-block';
            showAlert('A enviar os seus dados, por favor aguarde...', 'info');

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Cria um ID único para o registo aqui no frontend
            data.idRegistro = self.crypto.randomUUID();
            data.statusPreenchimento = 'ALUNO';

            try {
                const response = await fetch(`${API_URL}/add-student`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Dados enviados com sucesso! A empresa e a coordenação foram notificadas.', 'success');
                    form.reset();
                    // Recarrega as opções do orientador após o reset
                    document.getElementById('nome-orientador').innerHTML = '<option value="">A carregar orientadores...</option>';
                    loadOrientadores();
                } else {
                    throw new Error(result.message || 'Ocorreu um erro desconhecido no servidor.');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert(`Erro ao enviar os dados: ${error.message}`, 'danger');
            } finally {
                button.disabled = false;
                spinner.style.display = 'none';
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>`;
        }
    </script>
</body>
</html>