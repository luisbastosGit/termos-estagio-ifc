<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termo de Compromisso de Estágio - Dados do Aluno</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f4f4; padding-top: 20px; }
        .container { max-width: 800px; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .spinner-border { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center mb-4">Termo de Compromisso de Estágio - Dados do Aluno</h2>
        <div id="alert-container"></div>
        <form id="student-form">
            
            <h4 class="mt-4 mb-3">Dados do Aluno</h4>
            <div class="form-row">
                <div class="form-group col-md-8">
                    <label for="nome-completo">Nome Completo do Aluno:</label>
                    <input type="text" class="form-control" id="nome-completo" name="nome-completo" required>
                </div>
                <div class="form-group col-md-4">
                    <label for="cpf">CPF:</label>
                    <input type="text" class="form-control" id="cpf" name="cpf" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="matricula">Matrícula:</label>
                    <input type="text" class="form-control" id="matricula" name="matricula" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="data-nascimento">Data de Nascimento:</label>
                    <input type="date" class="form-control" id="data-nascimento" name="data-nascimento" required>
                </div>
            </div>
            <div class="form-row">
                 <div class="form-group col-md-6">
                    <label for="email-aluno">E-mail do Aluno:</label>
                    <input type="email" class="form-control" id="email-aluno" name="email-aluno" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="telefone-aluno">Telefone/WhatsApp do Aluno:</label>
                    <input type="text" class="form-control" id="telefone-aluno" name="telefone-aluno" required>
                </div>
            </div>
            <div class="form-row">
                 <div class="form-group col-md-6">
                    <label for="curso">Curso:</label>
                    <select class="form-control" id="curso" name="curso" required>
                        <option value="">Selecione o Curso</option>
                        <option value="Técnico em Agropecuária Integrado ao Ensino Médio">Técnico em Agropecuária Integrado ao Ensino Médio</option>
                        <option value="Técnico em Alimentos Integrado ao Ensino Médio">Técnico em Alimentos Integrado ao Ensino Médio</option>
                    </select>
                </div>
                 <div class="form-group col-md-6">
                    <label for="turma-fase">Turma / Fase:</label>
                    <select class="form-control" id="turma-fase" name="turma-fase" required>
                        <option value="">Selecione a Turma/Fase</option>
                        <option value="1ª A">1ª A</option><option value="1ª B">1ª B</option><option value="1ª C">1ª C</option>
                        <option value="2ª A">2ª A</option><option value="2ª B">2ª B</option><option value="2ª C">2ª C</option>
                        <option value="3ª A">3ª A</option><option value="3ª B">3ª B</option><option value="3ª C">3ª C</option>
                    </select>
                </div>
            </div>
             <div class="form-group">
                <label for="nome-orientador">Nome do Orientador no IFC:</label>
                <select class="form-control" id="nome-orientador" name="nome-orientador" required>
                    <option value="">A carregar orientadores...</option>
                </select>
            </div>

            <h4 class="mt-5 mb-3">Dados da Empresa</h4>
            <div class="form-group">
                <label for="nome-concedente">Nome da Empresa / Concedente:</label>
                <input type="text" class="form-control" id="nome-concedente" name="nome-concedente" required>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="responsavel-concedente">Nome do Responsável pela Empresa:</label>
                    <input type="text" class="form-control" id="responsavel-concedente" name="responsavel-concedente" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="email-concedente">E-mail da Empresa:</label>
                    <input type="email" class="form-control" id="email-concedente" name="email-concedente" required>
                </div>
            </div>
             <div class="form-group">
                <label for="telefone-concedente">Telefone/WhatsApp da Empresa:</label>
                <input type="text" class="form-control" id="telefone-concedente" name="telefone-concedente" required>
            </div>

            <button type="submit" id="submit-button" class="btn btn-primary btn-block mt-4">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Enviar Dados e Notificar a Empresa
            </button>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        // URL da nossa nova API no Render (APENAS para buscar os orientadores)
        const API_URL = "https://api-estagios-backend.onrender.com";
        
        // URL do backend antigo do Apps Script (para ENVIAR os dados, como funcionava antes)
        const SCRIPT_URL_ALUNO = "https://script.google.com/macros/s/AKfycbx8gXf5L4D7Pb9E1i5M8x7nc4V9F2Z1g/exec";

        document.addEventListener('DOMContentLoaded', async () => {
            await loadOrientadores();
            document.getElementById('student-form').addEventListener('submit', enviarDadosAluno);
        });

        async function loadOrientadores() {
            const select = document.getElementById('nome-orientador');
            try {
                // Busca a lista na nossa nova API
                const response = await fetch(`${API_URL}/orientadores`);
                if (!response.ok) throw new Error(`Erro de rede: ${response.statusText}`);
                
                const result = await response.json();
                if (result.success) {
                    select.innerHTML = '<option value="">Selecione o Orientador</option>';
                    result.data.forEach(nome => {
                        const option = document.createElement('option');
                        option.value = nome;
                        option.textContent = nome;
                        select.appendChild(option);
                    });
                } else {
                    throw new Error(result.message || 'Não foi possível carregar os orientadores.');
                }
            } catch (error) {
                console.error('Erro ao carregar orientadores:', error);
                select.innerHTML = '<option value="">Não foi possível carregar a lista</option>';
                showAlert(`Não foi possível carregar os orientadores. (${error.message})`, 'danger');
            }
        }

        async function enviarDadosAluno(e) {
            e.preventDefault();
            const form = e.target;
            const button = document.getElementById('submit-button');
            const spinner = button.querySelector('.spinner-border');

            button.disabled = true;
            spinner.style.display = 'inline-block';
            showAlert('A enviar os seus dados, por favor aguarde...', 'info');

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.idRegistro = self.crypto.randomUUID();
            // A lógica de timestamp e status será tratada pelo Apps Script, como era antes
            data.statusPreenchimento = 'ALUNO';

            try {
                // Envia os dados para o backend antigo e funcional do Apps Script
                const response = await fetch(SCRIPT_URL_ALUNO, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' },
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showAlert('Dados enviados com sucesso! A empresa e a coordenação foram notificadas.', 'success');
                    form.reset();
                    // Recarrega as opções do orientador após o reset
                    document.getElementById('nome-orientador').innerHTML = '<option value="">A carregar orientadores...</option>';
                    loadOrientadores();
                } else {
                    throw new Error(result.message || 'Ocorreu um erro desconhecido no servidor.');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert(`Erro ao enviar os dados: ${error.message}`, 'danger');
            } finally {
                button.disabled = false;
                spinner.style.display = 'none';
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>`;
        }
    </script>
</body>
</html>


