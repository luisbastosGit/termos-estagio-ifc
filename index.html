<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Termo de Compromisso de Estágio - Aluno</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .form-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background-color: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, .15);
    }

    .spinner-border {
      display: none;
    }
  </style>
</head>

<body>
  <div class="form-container">
    <h3 class="text-center mb-4">Termo de Compromisso de Estágio - Dados do Aluno</h3>
    <div id="alert-container"></div>
    <form id="student-form">

      <!-- Dados do Aluno -->
      <div class="row">
        <div class="col-md-8 mb-3">
          <label for="nome-completo" class="form-label">Nome Completo do Aluno:</label>
          <input type="text" class="form-control" id="nome-completo" name="nome-completo" required>
        </div>
        <div class="col-md-4 mb-3">
            <label for="cpf" class="form-label">CPF:</label>
            <input type="text" class="form-control" id="cpf" name="cpf" required>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-6 mb-3">
            <label for="matricula" class="form-label">Matrícula:</label>
            <input type="text" class="form-control" id="matricula" name="matricula" required>
        </div>
        <div class="col-md-6 mb-3">
            <label for="data-nascimento" class="form-label">Data de Nascimento:</label>
            <input type="date" class="form-control" id="data-nascimento" name="data-nascimento" required>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-7 mb-3">
            <label for="email-aluno" class="form-label">E-mail do Aluno:</label>
            <input type="email" class="form-control" id="email-aluno" name="email-aluno" required>
        </div>
        <div class="col-md-5 mb-3">
            <label for="telefone-aluno" class="form-label">Telefone/WhatsApp do Aluno:</label>
            <input type="tel" class="form-control" id="telefone-aluno" name="telefone-aluno" required>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="curso" class="form-label">Curso:</label>
          <select class="form-select" id="curso" name="curso" required>
            <option selected disabled value="">Selecione o Curso</option>
            <option>Técnico em Agropecuária Integrado ao Ensino Médio</option>
            <option>Técnico em Alimentos Integrado ao Ensino Médio</option>
            <option>Técnico em Informática Integrado ao Ensino Médio</option>
            <option>Técnico em Agropecuária Subsequente</option>
            <option>Técnico em Alimentos Subsequente</option>
            <option>Agronomia</option>
            <option>Ciência da Computação</option>
            <option>Engenharia de Alimentos</option>
            <option>Licenciatura em Física</option>
            <option>Licenciatura em Matemática</option>
            <option>Medicina Veterinária</option>
            <option>Zootecnia</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
            <label for="turma-fase" class="form-label">Turma / Fase:</label>
            <select class="form-select" id="turma-fase" name="turma-fase" required>
                <option selected disabled value="">Selecione a Turma/Fase</option>
                <option>1ª A</option>
                <option>1ª B</option>
                <option>1ª C</option>
                <option>2ª A</option>
                <option>2ª B</option>
                <option>2ª C</option>
                <option>3ª A</option>
                <option>3ª B</option>
                <option>3ª C</option>
            </select>
        </div>
      </div>

      <!-- NOVO DROPDOWN PARA ORIENTADOR -->
      <div class="mb-3">
        <label for="nome-orientador" class="form-label">Nome do Orientador no IFC:</label>
        <select class="form-select" id="nome-orientador" name="nome-orientador" required>
            <option value="" selected disabled>Carregando orientadores...</option>
        </select>
      </div>

      <button type="submit" id="submit-button" class="btn btn-primary w-100">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        <span id="button-text">Próximo Passo (Enviar para Empresa)</span>
      </button>

    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const studentForm = document.getElementById('student-form');
    const submitButton = document.getElementById('submit-button');
    const buttonText = document.getElementById('button-text');
    const spinner = submitButton.querySelector('.spinner-border');
    const alertContainer = document.getElementById('alert-container');
    const orientadorSelect = document.getElementById('nome-orientador');

    // URL da nossa API no Render
    const API_URL = "https://api-estagios-backend.onrender.com";

    // ATENÇÃO: Substitua pela URL de implantação do seu script Apps Script original que recebe os dados do aluno.
    const SCRIPT_URL_ALUNO = "https://script.google.com/macros/s/AKfycbx0q_xG_.../exec"; 
    
    /**
     * Carrega a lista de orientadores da nossa nova API e preenche o dropdown
     */
    async function loadOrientadores() {
        try {
            const response = await fetch(`${API_URL}/orientadores`);
            if (!response.ok) {
                throw new Error(`A API retornou um erro: ${response.status} ${response.statusText}`);
            }
            const result = await response.json();

            if (result.success && result.data) {
                orientadorSelect.innerHTML = '<option value="" selected disabled>Selecione o Orientador</option>'; // Limpa o "Carregando..."
                result.data.forEach(orientador => {
                    const option = document.createElement('option');
                    option.value = orientador;
                    option.textContent = orientador;
                    orientadorSelect.appendChild(option);
                });
            } else {
                throw new Error(result.message || "A API retornou uma resposta inesperada.");
            }
        } catch (error) {
            console.error('Erro detalhado ao carregar orientadores:', error);
            orientadorSelect.innerHTML = '<option value="" selected disabled>Erro ao carregar a lista</option>';
            showAlert(`Não foi possível carregar os orientadores. (${error.message})`, 'danger');
        }
    }

    // Carrega os orientadores assim que a página é aberta
    document.addEventListener('DOMContentLoaded', loadOrientadores);

    /**
     * Lida com o envio do formulário do aluno para o backend antigo (Apps Script)
     */
    studentForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Desativa o botão e mostra o spinner
        submitButton.disabled = true;
        spinner.style.display = 'inline-block';
        buttonText.textContent = 'Enviando...';
        alertContainer.innerHTML = '';

        const formData = new FormData(studentForm);
        
        // Mantém a lógica de envio para o backend antigo
        try {
            const response = await fetch(SCRIPT_URL_ALUNO, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.status === 'success') {
                showAlert('Dados enviados com sucesso! A empresa receberá um e-mail para completar o cadastro.', 'success');
                studentForm.reset(); // Limpa o formulário
                buttonText.textContent = 'Enviado!';
            } else {
                throw new Error(result.message || 'Ocorreu um erro desconhecido.');
            }
        } catch (error) {
            showAlert(`Erro ao enviar os dados: ${error.message}`, 'danger');
            // Reativa o botão em caso de erro
            submitButton.disabled = false;
            spinner.style.display = 'none';
            buttonText.textContent = 'Tentar Novamente';
        }
    });

    function showAlert(message, type) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
      alertContainer.append(wrapper);
    }
  </script>
</body>
</html>

